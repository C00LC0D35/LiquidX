/*
 * FDPClient Hacked Client
 * A free open source mixin-based injection hacked client for Minecraft using Minecraft Forge by LiquidBounce.
 * https://github.com/SkidderMC/FDPClient/
 */
package net.ccbluex.liquidbounce.features.module.modules.exploit.disablers.other;

import io.netty.util.concurrent.GenericFutureListener;
import net.ccbluex.liquidbounce.LiquidBounce;
import net.ccbluex.liquidbounce.event.PacketEvent;
import net.ccbluex.liquidbounce.features.module.modules.combat.KillAura;
import net.ccbluex.liquidbounce.features.module.modules.exploit.disablers.DisablerMode;
import net.ccbluex.liquidbounce.features.module.modules.world.Scaffold;
import net.minecraft.client.entity.EntityPlayerSP;
import net.minecraft.network.Packet;
import net.minecraft.network.play.client.*;
import net.minecraft.network.status.client.C01PacketPing;

import java.util.Objects;

public final class CubeCraft extends DisablerMode {

    public CubeCraft() {
        super("CubeCraft");
    }

    KillAura killAura = (KillAura) LiquidBounce.moduleManager.getModule(KillAura.class);
    EntityPlayerSP entityPlayerSP;

    @Override
    public void onPacket(PacketEvent event) {
        if(killAura == null) {
            return;
        }

        Packet p = event.getPacket();

        if (p instanceof C03PacketPlayer.C06PacketPlayerPosLook && !Objects.requireNonNull(LiquidBounce.moduleManager.getModule(Scaffold.class)).isToggled()) {
            event.cancelEvent();
        }
        if (p instanceof C03PacketPlayer && !((C03PacketPlayer)p).isMoving() && !mc.thePlayer.isUsingItem()) {
            event.cancelEvent();
        }
        if (p instanceof C00PacketKeepAlive) {
            event.cancelEvent();
        }
        if (p instanceof C0FPacketConfirmTransaction) {
            event.cancelEvent();
        }
        if (p instanceof C0CPacketInput) {
            event.cancelEvent();
        }
        if (p instanceof C01PacketPing) {
            event.cancelEvent();
        }
        if (killAura.getTarget() == null) {
            assert (p instanceof C0BPacketEntityAction);
            C0BPacketEntityAction c0B = (C0BPacketEntityAction)p;
            if (c0B.getAction().equals(C0BPacketEntityAction.Action.START_SPRINTING)) {
                if (entityPlayerSP.serverSprintState) {
                    sendPacketSilent(new C0BPacketEntityAction(mc.thePlayer, C0BPacketEntityAction.Action.STOP_SPRINTING));
                    entityPlayerSP.serverSprintState = false;
                }
                event.cancelEvent();
            }
        }
    }

    public void sendPacketSilent(Packet packet) {
        mc.getNetHandler().getNetworkManager().sendPacket(packet, null, new GenericFutureListener[0]);
    }
}
